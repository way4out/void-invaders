<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Void Invaders: Galactic Grind</title>
    <style>
        body { background: #000 url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxkZWZzPjxwYXR0ZXJuIGlkPSJzdGFycyIgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBwYXR0ZXJuVW5pdHM9InVzZXJTcGFjZU9uVXNlIj48Y2lyY2xlIGN4PSIyNSIgyT0iMjUiIHI9IjEiIGZpbGw9IiNmZmYiLz48Y2lyY2xlIGN4PSIxMCIgyT0iMTAiIHI9IjAuNSIgZmlsbD0iI2ZmZiIvPjxyZW1vdGUgY3g9IjQwIiBjeT0iNDAiIHI9IjAuNSIgZmlsbD0iI2ZmZiIvPjwvcGF0dGVybj48L2RlZnM+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNzdGFycykiLz48L3N2Zz4=') repeat; color: #0f0; font-family: 'Courier New', monospace; text-align: center; margin: 0; padding: 0; overflow: hidden; touch-action: none; }
        h1 { text-shadow: 0 0 10px #0f0, 0 0 20px #0f0; animation: glow 1.5s infinite alternate; }
        @keyframes glow { 0% { text-shadow: 0 0 5px #0f0; } 100% { text-shadow: 0 0 20px #0f0, 0 0 30px #0f0; } }
        canvas { border: 2px solid #0f0; background: rgba(17, 17, 17, 0.8); display: block; margin: 0 auto; width: 100%; height: calc(100vh - 60px); touch-action: none; border-radius: 10px; box-shadow: 0 0 20px #0f0; }
        #controls { display: flex; justify-content: center; flex-wrap: wrap; gap: 5px; margin: 5px; position: absolute; z-index: 10; width: 100%; }
        button { background: linear-gradient(#0f0, #00f); color: #000; border: none; padding: 8px 15px; cursor: pointer; font-family: inherit; border-radius: 5px; text-shadow: 0 0 5px #fff; transition: transform 0.2s; }
        button:hover { transform: scale(1.1); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #status { font-size: 12px; position: absolute; top: 10px; left: 10px; z-index: 10; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 5px; }
        #ticker { position: absolute; top: 0; left: 0; width: 100%; background: rgba(0,255,0,0.1); font-size: 10px; white-space: nowrap; animation: scroll 20s linear infinite; z-index: 10; }
        @keyframes scroll { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .shard-display { display: inline-block; margin: 2px; padding: 2px 5px; background: rgba(17,17,17,0.8); border: 1px solid #0f0; border-radius: 5px; box-shadow: 0 0 5px #0f0; }
        #viewsTicker { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.5); color: #0f0; font-size: 10px; text-align: center; padding: 5px; z-index: 10; border-top: 1px solid #0f0; }
        #achievement { position: absolute; bottom: 40px; left: 10px; color: #f00; font-size: 14px; z-index: 10; animation: fadeIn 2s; }
        @keyframes fadeIn { 0% { opacity: 0; } 100% { opacity: 1; } }
        #leaderboard { position: absolute; top: 50px; right: 10px; background: rgba(17,17,17,0.8); padding: 10px; border: 1px solid #0f0; z-index: 10; border-radius: 5px; box-shadow: 0 0 10px #0f0; }
        #lbList { list-style-type: none; padding: 0; }
        #lbList li { margin: 2px 0; }
    </style>
</head>
<body>
    <div id="ticker">$WAY4OUT: $0.0012 ↑2% | $COIN4: $0.0045 ↑15% | $TR3B: $0.0008 ↓1% | Grind to Mine!</div>
    <h1>Void Invaders: Galactic Grind</h1>
    <p>Defend the void, mine shards, redeem for $WAY4OUT/$COIN4/$TR3B on Base!</p>
    <button id="connectWallet">Connect MetaMask (Base)</button>
    <p id="walletStatus">Wallet: Disconnected</p>
    <div id="controls">
        <button id="claimAirdrop">Claim Airdrop</button>
        <button id="mintNFT">Mint Bunker NFT</button>
        <button id="equipNFT">Equip NFT</button>
        <button id="upgradeCoin4">Quad Boost ($COIN4 x1)</button>
        <button id="escapeWay4">Warp Escape ($WAY4OUT x1)</button>
        <button id="scanTr3b">Oracle Scan ($TR3B x1)</button>
        <button id="redeemWay4">Redeem $WAY4OUT</button>
        <button id="redeemCoin4">Redeem $COIN4</button>
        <button id="redeemTr3b">Redeem $TR3B</button>
        <button id="buyWay4out">Buy $WAY4OUT</button>
        <button id="buyCoin4">Buy $COIN4</button>
        <button id="buyTr3b">Buy $TR3B</button>
        <button id="watchAd">Watch Ad for Boost</button>
        <button id="fullScreen">Full Screen</button>
        <button id="toggleMusic">Music On/Off</button>
    </div>
    <canvas id="gameCanvas"></canvas>
    <div id="status">
        <span class="shard-display">Score: <span id="score">0</span></span>
        <span class="shard-display">$WAY4OUT: <span id="way4Shards">0</span></span>
        <span class="shard-display">$COIN4: <span id="coin4Shards">0</span></span>
        <span class="shard-display">$TR3B: <span id="tr3bShards">0</span></span>
        <span class="shard-display">Wave: <span id="wave">1</span></span>
    </div>
    <div id="leaderboard">
        <h3>Leaderboard</h3>
        <ul id="lbList"></ul>
    </div>
    <div id="achievement">Achievement Unlocked: None</div>
    <div id="viewsTicker">Total Views: <span id="viewsCount">0</span></div>
    <audio id="bgMusic" loop>
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLI9ErK+9gA=" type="audio/wav">
    </audio>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const elements = {
            score: document.getElementById('score'), way4Shards: document.getElementById('way4Shards'),
            coin4Shards: document.getElementById('coin4Shards'), tr3bShards: document.getElementById('tr3bShards'),
            wave: document.getElementById('wave'), walletStatus: document.getElementById('walletStatus'),
            viewsCount: document.getElementById('viewsCount'), lbList: document.getElementById('lbList'),
            achievement: document.getElementById('achievement')
        };
        const buttons = {
            connect: document.getElementById('connectWallet'), upgradeCoin4: document.getElementById('upgradeCoin4'),
            escapeWay4: document.getElementById('escapeWay4'), scanTr3b: document.getElementById('scanTr3b'),
            redeemWay4: document.getElementById('redeemWay4'), redeemCoin4: document.getElementById('redeemCoin4'),
            redeemTr3b: document.getElementById('redeemTr3b'), claimAirdrop: document.getElementById('claimAirdrop'),
            mintNFT: document.getElementById('mintNFT'), equipNFT: document.getElementById('equipNFT'),
            buyWay4out: document.getElementById('buyWay4out'), buyCoin4: document.getElementById('buyCoin4'),
            buyTr3b: document.getElementById('buyTr3b'), watchAd: document.getElementById('watchAd'),
            fullScreen: document.getElementById('fullScreen'), toggleMusic: document.getElementById('toggleMusic')
        };

        let web3, provider, account, contracts = {};
        const CHAIN_ID = 8453; // Base
        const REWARD_ADDRESS = '0xCeA57eEdA6eF19ce51caBE00e4CF425a31802D74';
        const ZORA_CONTRACT = '0x5d8c2f7c4e7d5d8a2c6f8e8a9d7b6c5f4e3d2c1a'; // Your Zora collection
        const ZORA_ABI = [{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeMint","outputs":[],"stateMutability":"nonpayable","type":"function"}];
        const ERC20_ABI = [{"inputs":[{"internalType":"address","name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"balance","type":"uint256"}],"stateMutability":"view","type":"function"},
{"inputs":[{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
{"inputs":[{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"burn","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"}];

        const CONTRACTS = {
            WAY4OUT: { address: '0xd07379a755a8f11b57610154861d694b2a0f615a', abi: ERC20_ABI, decimals: 18 },
            COIN4: { address: '0x4deeba0fca2f9a8b307b891241eac57b6bf713ec', abi: ERC20_ABI, decimals: 18 },
            TR3B: { address: '0x98a8165a44782ab43c378ed9f501d55ec51b2880', abi: ERC20_ABI, decimals: 18 }
        };

        let gameState = JSON.parse(localStorage.getItem('voidInvaders')) || {
            score: 0, way4Shards: 0, coin4Shards: 0, tr3bShards: 0, wave: 1, highScore: 0,
            player: { x: 375, y: 550, width: 50, height: 20, speed: 5, shields: 1, powerUp: null },
            upgrades: { laserSpeed: 1, escapeUsed: false }, airdropClaimed: false
        };
        let invaders = [], bullets = [], invaderBullets = [], barriers = [], particles = [], powerUps = [];
        let keys = {}, touchX = 0, touchY = 0, touchActive = false, music = document.getElementById('bgMusic'), musicPlaying = false;
        let audioCtx, nextDrop = 'WAY4OUT';

        // Views Ticker (LocalStorage, +1 per session)
        let views = parseInt(localStorage.getItem('voidViews') || '0') + 1;
        localStorage.setItem('voidViews', views.toString());
        elements.viewsCount.textContent = views;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight - 30; // Room for views ticker
            gameState.player.x = canvas.width / 2 - 25;
            gameState.player.y = canvas.height - 50;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function init() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            initInvaders();
            initBarriers();
            updateDisplay();
            requestAnimationFrame(gameLoop);
            loadContracts();
            if (gameState.wave % 10 === 0) dailyEvent();
        }

        async function loadContracts() {
            if (!web3) return;
            Object.keys(CONTRACTS).forEach(key => {
                contracts[key] = new web3.eth.Contract(CONTRACTS[key].abi, CONTRACTS[key].address);
            });
        }

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            updatePlayer();
            updateInvaders();
            updateBullets();
            updateInvaderBullets();
            updateBarriers();
            updateParticles();
            updatePowerUps();
            checkCollisions();
            drawAll();
            saveState();
            requestAnimationFrame(gameLoop);
        }

        function updatePlayer() {
            if (touchActive) {
                const dx = touchX - gameState.player.x - gameState.player.width / 2;
                gameState.player.x += dx * 0.1;
                gameState.player.x = Math.max(0, Math.min(canvas.width - gameState.player.width, gameState.player.x));
            } else {
                if (keys['ArrowLeft']) gameState.player.x = Math.max(0, gameState.player.x - gameState.player.speed);
                if (keys['ArrowRight']) gameState.player.x = Math.min(canvas.width - gameState.player.width, gameState.player.x + gameState.player.speed);
            }
            ctx.fillStyle = gameState.player.shields > 1 ? '#0ff' : '#0f0';
            ctx.fillRect(gameState.player.x, gameState.player.y, gameState.player.width, gameState.player.height);
        }

        function initInvaders() {
            invaders = [];
            const rows = Math.min(5 + gameState.wave / 2, 10), cols = 10;
            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    invaders.push({ x: 50 + j * 60, y: 50 + i * 40, width: 40, height: 20, dir: 1, shootTimer: Math.random() * 100 });
                }
            }
            if (gameState.wave % 5 === 0) initBoss();
        }
        function updateInvaders() {
            let edge = false;
            invaders.forEach(inv => {
                inv.x += inv.dir * (0.5 + gameState.wave * 0.1);
                if (inv.x > canvas.width - inv.width || inv.x < 0) edge = true;
                inv.shootTimer++;
                if (inv.shootTimer > 200 - gameState.wave * 5 && Math.random() < 0.02) {
                    invaderBullets.push({ x: inv.x + 20, y: inv.y + 20, speed: 3 });
                    inv.shootTimer = 0; playSound(200, 0.1);
                }
                if (Math.random() < 0.001 * gameState.wave) dropPowerUp(inv.x, inv.y);
            });
            if (edge) {
                invaders.forEach(inv => { inv.dir *= -1; inv.y += 30; });
                if (invaders[0] && invaders[0].y > canvas.height - 200) gameOver();
            }
            if (invaders.length === 0) { gameState.wave++; gameState.score += 1000 * gameState.wave; initInvaders(); dailyEvent(); }
        }

        function initBoss() {
            invaders.push({ x: canvas.width / 2 - 50, y: 50, width: 100, height: 40, dir: 1, health: 50, isBoss: true });
        }

        function updateBullets() {
            bullets.forEach((b, i) => {
                b.y -= 10 * gameState.upgrades.laserSpeed;
                if (b.y < 0) bullets.splice(i, 1);
            });
            invaderBullets.forEach((b, i) => {
                b.y += b.speed;
                if (b.y > canvas.height) invaderBullets.splice(i, 1);
            });
        }

        function initBarriers() {
            barriers = [];
            for (let i = 0; i < 3; i++) {
                barriers.push({ x: canvas.width / 4 + i * (canvas.width / 4), y: canvas.height - 100, width: 100, height: 20, health: 3 });
            }
        }

        function createParticles(x, y, count = 20) {
            for (let i = 0; i < count; i++) {
                particles.push({ x, y, vx: Math.random() * 6 - 3, vy: Math.random() * 6 - 3, life: 30, color: '#0f0' });
            }
            if ('vibrate' in navigator) navigator.vibrate(50);
        }
        function updateParticles() {
            particles.forEach((p, i) => {
                p.x += p.vx;
                p.y += p.vy;
                p.life--;
                if (p.life <= 0) particles.splice(i, 1);
            });
        }

        function dropPowerUp(x, y) {
            const types = ['triple', 'shield'];
            powerUps.push({ x, y, type: types[Math.floor(Math.random() * types.length)], speed: 2 });
        }
        function updatePowerUps() {
            powerUps.forEach((pu, i) => {
                pu.y += pu.speed;
                if (pu.y > canvas.height) powerUps.splice(i, 1);
                if (pu.x > gameState.player.x && pu.x < gameState.player.x + gameState.player.width && pu.y > gameState.player.y && pu.y < gameState.player.y + gameState.player.height) {
                    powerUps.splice(i, 1);
                    gameState.player.powerUp = pu.type;
                    setTimeout(() => gameState.player.powerUp = null, 10000);
                    alert(pu.type === 'triple' ? 'Triple Shot!' : 'Invincibility Shield!');
                }
            });
        }

        function checkCollisions() {
            bullets.forEach((b, bi) => {
                invaders.forEach((inv, ii) => {
                    if (b.x > inv.x && b.x < inv.x + inv.width && b.y > inv.y && b.y < inv.y + inv.height) {
                        if (inv.isBoss) { inv.health--; if (inv.health <= 0) invaders.splice(ii, 1); } else invaders.splice(ii, 1);
                        bullets.splice(bi, 1);
                        gameState.score += 10; dropShard(); playSound(800, 0.2); createParticles(inv.x + inv.width / 2, inv.y + inv.height / 2);
                    }
                });
                barriers.forEach((bar, bai) => {
                    if (b.x > bar.x && b.x < bar.x + bar.width && b.y > bar.y && b.y < bar.y + bar.height) {
                        bullets.splice(bi, 1);
                    }
                });
            });
            invaderBullets.forEach((ib, ii) => {
                if (ib.x > gameState.player.x && ib.x < gameState.player.x + gameState.player.width &&
                    ib.y > gameState.player.y && ib.y < gameState.player.y + gameState.player.height) {
                    invaderBullets.splice(ii, 1); damagePlayer();
                }
                barriers.forEach((bar, bai) => {
                    if (ib.x > bar.x && ib.x < bar.x + bar.width && ib.y > bar.y && ib.y < bar.y + bar.height) {
                        invaderBullets.splice(ii, 1); bar.health--; if (bar.health <= 0) barriers.splice(bai, 1);
                    }
                });
            });
        }

        function dropShard() {
            const coins = ['way4Shards', 'coin4Shards', 'tr3bShards'];
            gameState[coins[Math.floor(Math.random() * 3)]]++;
            playSound(600, 0.15);
        }

        function damagePlayer() {
            gameState.player.shields--;
            if (gameState.player.shields <= 0) {
                gameOver();
            } else {
                playSound(100, 0.3); if ('vibrate' in navigator) navigator.vibrate(100);
            }
        }
        function gameOver() {
            alert(`Game Over! Score: ${gameState.score}. High: ${gameState.highScore}`);
            location.reload();
        }

        function shoot() {
            const x = gameState.player.x + gameState.player.width / 2;
            bullets.push({ x, y: gameState.player.y });
            if (gameState.player.powerUp === 'triple') {
                bullets.push({ x: x - 10, y: gameState.player.y });
                bullets.push({ x: x + 10, y: gameState.player.y });
            }
            playSound(1000, 0.1);
        }

        function drawAll() {
            ctx.fillStyle = gameState.player.shields > 1 ? '#0ff' : '#0f0';
            ctx.fillRect(gameState.player.x, gameState.player.y, gameState.player.width, gameState.player.height);
            ctx.fillStyle = '#f00';
            invaders.forEach(inv => ctx.fillRect(inv.x, inv.y, inv.width, inv.height));
            ctx.fillStyle = '#fff'; bullets.forEach(b => ctx.fillRect(b.x, b.y, 3, 8));
            ctx.fillStyle = '#f80'; invaderBullets.forEach(b => ctx.fillRect(b.x, b.y, 3, 8));
            ctx.fillStyle = '#0a0'; barriers.forEach(bar => ctx.fillRect(bar.x, bar.y, bar.width, bar.height));
            particles.forEach(p => { ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 2, 2); });
            powerUps.forEach(pu => { ctx.fillStyle = pu.type === 'triple' ? '#ff0' : '#0ff'; ctx.fillRect(pu.x, pu.y, 20, 20); });
        }

        document.addEventListener('keydown', e => {
            keys[e.key] = true;
            if (e.key === ' ') shoot();
        });
        document.addEventListener('keyup', e => keys[e.key] = false);
        canvas.addEventListener('touchstart', e => {
            touchActive = true;
            touchX = e.touches[0].clientX;
            touchY = e.touches[0].clientY;
            if (touchY < canvas.height / 2) shoot();
            e.preventDefault();
        });
        canvas.addEventListener('touchmove', e => {
            touchX = e.touches[0].clientX;
            touchY = e.touches[0].clientY;
            e.preventDefault();
        });
        canvas.addEventListener('touchend', e => touchActive = false);

        function playSound(freq, duration) {
            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.frequency.value = freq; gain.gain.setValueAtTime(0.3, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }

        function updateDisplay() {
            elements.score.textContent = gameState.score;
            elements.way4Shards.textContent = gameState.way4Shards;
            elements.coin4Shards.textContent = gameState.coin4Shards;
            elements.tr3bShards.textContent = gameState.tr3bShards;
            elements.wave.textContent = gameState.wave;
            if (gameState.score > gameState.highScore) gameState.highScore = gameState.score;
        }
        function saveState() { localStorage.setItem('voidInvaders', JSON.stringify(gameState)); }

        function dailyEvent() {
            const bonus = Math.floor(Math.random() * 5) + 1;
            gameState.way4Shards += bonus; gameState.coin4Shards += bonus; gameState.tr3bShards += bonus;
            alert(`Event Airdrop: +${bonus} shards each!`);
        }

        async function connectWallet() {
            if (!window.ethereum) {
                provider = new WalletConnectProvider({ rpc: { 8453: "https://mainnet.base.org" } });
                await provider.enable();
                web3 = new Web3(provider);
            } else {
                web3 = new Web3(window.ethereum);
            }
            try {
                await ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x2105' }] });
                const accounts = await web3.eth.requestAccounts();
                account = accounts[0];
                elements.walletStatus.textContent = `Wallet: ${account.slice(0,6)}...${account.slice(-4)}`;
                buttons.connect.disabled = true; loadContracts();
                ethereum.on('accountsChanged', () => location.reload());
            } catch (err) { alert('Connect failed: ' + err.message); }
        }
        buttons.connect.onclick = connectWallet;

        buttons.claimAirdrop.onclick = () => {
            if (!account || gameState.airdropClaimed) return alert('Already claimed or connect wallet!');
            gameState.way4Shards += 10; gameState.coin4Shards += 10; gameState.tr3bShards += 10;
            gameState.airdropClaimed = true; updateDisplay(); saveState();
            alert('Airdrop claimed: 10 shards each!');
        };

        buttons.mintNFT.onclick = async () => {
            if (!account) return alert('Connect wallet!');
            try {
                const tokenId = Date.now();
                await contracts.ZORA.methods.safeMint(account, tokenId).send({ from: account, value: web3.utils.toWei('0.001', 'ether') });
                alert('Bunker NFT minted!');
            } catch (err) { alert('Mint failed: ' + err.message); }
        };

        buttons.equipNFT.onclick = async () => {
            if (!account) return alert('Connect wallet!');
            try {
                const balance = await contracts.ZORA.methods.balanceOf(account).call();
                if (balance > 0) {
                    gameState.player.nftSkin = true; // Simple flag for visual
                    alert('NFT equipped! Ship upgraded.');
                } else alert('No NFTs owned!');
            } catch (err) { alert('Equip failed: ' + err.message); }
        };

        buttons.buyWay4out.onclick = () => openSwap(CONTRACTS.WAY4OUT.address);
        buttons.buyCoin4.onclick = () => openSwap(CONTRACTS.COIN4.address);
        buttons.buyTr3b.onclick = () => openSwap(CONTRACTS.TR3B.address);

        function openSwap(token) {
            if (!account) return alert('Connect wallet!');
            window.open(`https://app.uniswap.org/swap?outputCurrency=${token}&chain=base`, '_blank');
        }

        buttons.watchAd.onclick = () => {
            // Placeholder rewarded ad – replace with real AdMob
            alert('Ad watched: +5 shards boost!');
            gameState.way4Shards += 5; updateDisplay();
        };

        init();
    </script>
</body>
</html>
